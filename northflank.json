{
  "$schema": "https://northflank.com/schemas/v1/template",
  "apiVersion": "v1.2",
  "spec": {
    "kind": "Workflow",
    "spec": {
      "type": "sequential",
      "steps": [
        {
          "kind": "Project",
          "ref": "project",
          "spec": {
            "name": "kosmos",
            "description": "Kosmos AI Scientist - Autonomous scientific research",
            "region": "europe-west",
            "color": "#6366F1"
          }
        },
        {
          "kind": "SecretGroup",
          "ref": "secrets",
          "spec": {
            "name": "kosmos-secrets",
            "secretType": "environment-arguments",
            "description": "API keys and sensitive configuration for Kosmos",
            "priority": 10,
            "secrets": {
              "variables": {
                "ANTHROPIC_API_KEY": "${args.ANTHROPIC_API_KEY}",
                "OPENAI_API_KEY": "${args.OPENAI_API_KEY}"
              }
            },
            "projectId": "${refs.project.id}",
            "restrictions": {
              "restricted": false,
              "nfObjects": [],
              "tags": []
            }
          }
        },
        {
          "kind": "Addon",
          "ref": "postgres",
          "spec": {
            "name": "kosmos1-postgres",
            "type": "postgresql",
            "version": "15-latest",
            "billing": {
              "deploymentPlan": "nf-compute-50",
              "storageClass": "nvme",
              "storage": 10240,
              "replicas": 1
            },
            "typeSpecificSettings": {},
            "tlsEnabled": true,
            "externalAccessEnabled": false,
            "projectId": "${refs.project.id}"
          }
        },
        {
          "kind": "Addon",
          "ref": "redis",
          "spec": {
            "name": "kosmos-redis",
            "type": "redis",
            "version": "7-latest",
            "billing": {
              "deploymentPlan": "nf-compute-20",
              "storage": 4096,
              "storageClass": "nvme",
              "replicas": 1
            },
            "typeSpecificSettings": {},
            "tlsEnabled": true,
            "externalAccessEnabled": false,
            "projectId": "${refs.project.id}"
          }
        },
        {
          "kind": "CombinedService",
          "ref": "app",
          "spec": {
            "name": "kosmos-app",
            "billing": {
              "deploymentPlan": "nf-compute-200"
            },
            "deployment": {
              "instances": 1
            },
            "ports": [
              {
                "name": "http",
                "internalPort": 8000,
                "public": true,
                "protocol": "HTTP",
                "security": {
                  "credentials": [],
                  "policies": [],
                  "sso": {}
                }
              }
            ],
            "healthChecks": [
              {
                "type": "livenessProbe",
                "protocol": "HTTP",
                "port": 8000,
                "path": "/health",
                "initialDelaySeconds": 30,
                "periodSeconds": 30,
                "timeoutSeconds": 10,
                "failureThreshold": 3
              }
            ],
            "buildSettings": {
              "dockerfile": {
                "buildEngine": "kaniko",
                "dockerFilePath": "/Dockerfile",
                "dockerWorkDir": "/"
              }
            },
            "buildConfiguration": {
              "pathIgnoreRules": [],
              "isAllowList": false
            },
            "vcsData": {
              "projectType": "github",
              "projectUrl": "${args.GITHUB_REPO}",
              "projectBranch": "${args.GITHUB_BRANCH}"
            },
            "runtimeEnvironment": {
              "LOG_LEVEL": "INFO",
              "PYTHONUNBUFFERED": "1",
              "PYTHONDONTWRITEBYTECODE": "1",
              "PYTHONPATH": "/app",
              "KOSMOS_DATA_DIR": "/app/data",
              "KOSMOS_LOG_DIR": "/app/logs",
              "KOSMOS_CACHE_DIR": "/app/cache",
              "REDIS_ENABLED": "true",
              "CLAUDE_MODEL": "claude-sonnet-4-20250514",
              "ENABLE_CONCURRENT_OPERATIONS": "true",
              "MAX_CONCURRENT_EXPERIMENTS": "4"
            },
            "projectId": "${refs.project.id}",
            "disabledCI": false,
            "buildArguments": {}
          }
        }
      ]
    }
  },
  "arguments": {
    "ANTHROPIC_API_KEY": {
      "description": "Anthropic API key for Claude access (required)",
      "required": true,
      "secret": true
    },
    "OPENAI_API_KEY": {
      "description": "OpenAI API key (optional, for OpenAI provider)",
      "required": false,
      "secret": true,
      "default": ""
    },
    "GITHUB_REPO": {
      "description": "GitHub repository URL",
      "required": false,
      "default": "https://github.com/oovac/Kosmos"
    },
    "GITHUB_BRANCH": {
      "description": "GitHub branch to deploy",
      "required": false,
      "default": "master"
    }
  }
}